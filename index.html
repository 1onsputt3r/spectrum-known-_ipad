<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>å…‰è­œåˆ†æï¼ˆå·²çŸ¥æ ¡æ­£åƒæ•¸ï¼‰</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root{--primary-color:#3b82f6;--primary-dark:#2563eb;--secondary-color:#22c55e;--secondary-dark:#16a34a;--danger-color:#ef4444;--danger-dark:#dc2626;--background-color:#f8fafc;--text-color:#0f172a;--border-color:#cbd5e1;--border-radius:10px;--safe-area-inset-top:env(safe-area-inset-top,0);--safe-area-inset-bottom:env(safe-area-inset-bottom,20px)}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:0 12px;padding-top:calc(var(--safe-area-inset-top) + 12px);padding-bottom:calc(var(--safe-area-inset-bottom) + 12px);background-color:var(--background-color);color:var(--text-color);overscroll-behavior-y:none;touch-action:manipulation}.container{max-width:100%;margin:0 auto;padding-bottom:30px}.header{text-align:center;padding:15px 0;margin-bottom:20px;position:sticky;top:0;background-color:var(--background-color);z-index:10}h1{font-size:24px;margin:0;font-weight:600}.canvas-container{position:relative;width:100%;max-width:800px;margin:0 auto 20px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);border-radius:var(--border-radius);overflow:hidden}canvas{display:block;width:100%;height:auto;border-radius:var(--border-radius);touch-action:none}.file-input-wrapper{display:flex;width:100%;flex-direction:column;gap:10px}.section{background-color:#fff;padding:20px;margin-bottom:20px;border-radius:var(--border-radius);box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.section-title{font-size:18px;font-weight:600;margin-top:0;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}.button-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px;margin-bottom:5px}button{-webkit-appearance:none;appearance:none;background-color:var(--primary-color);color:#fff;border:none;padding:12px 20px;font-size:16px;font-weight:500;border-radius:var(--border-radius);cursor:pointer;flex:1 0 auto;min-width:120px;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.1)}button:active{background-color:var(--primary-dark);transform:translateY(1px)}button:disabled{opacity:.6;cursor:not-allowed}.btn-secondary{background-color:var(--secondary-color)}.btn-secondary:active{background-color:var(--secondary-dark)}.btn-danger{background-color:var(--danger-color)}.btn-danger:active{background-color:var(--danger-dark)}.btn-outline{background-color:transparent;color:var(--primary-color);border:2px solid var(--primary-color)}.btn-outline:active{background-color:rgba(59,130,246,.1)}.plot-container{width:100%;height:300px;margin-top:20px;margin-bottom:10px}.cal-result{padding:10px;background-color:#f1f5f9;border-radius:var(--border-radius);font-weight:500;text-align:center;margin-bottom:15px}input[type=file]{display:none}.file-label{display:inline-flex;padding:12px 20px;background-color:var(--secondary-color);color:#fff;border-radius:var(--border-radius);cursor:pointer;font-weight:500;text-align:center;flex:1;box-shadow:0 1px 3px rgba(0,0,0,.1);align-items:center;justify-content:center;gap:8px}.file-label:active{background-color:var(--secondary-dark);transform:translateY(1px)}.file-name{margin-top:8px;font-size:14px;color:#64748b;word-break:break-all}table{width:100%;border-collapse:collapse;margin-bottom:15px}table td,table th{padding:12px 10px;text-align:left;border:1px solid var(--border-color)}table th{background-color:#f1f5f9;font-weight:600}.parameters-table{font-size:14px;margin-bottom:20px}.parameters-table td:first-child{font-weight:500;width:40%}.empty-state{text-align:center;padding:30px 20px;color:#64748b}.empty-state svg{width:60px;height:60px;margin-bottom:15px;color:#94a3b8}.empty-state h3{margin:0 0 10px;font-weight:600;color:var(--text-color)}.empty-state p{margin:0}@media only screen and (min-width:768px){.container{padding:20px;max-width:1000px}.plot-container{height:400px}button{padding:12px 24px}}@media only screen and (min-width:1024px){.container{padding:30px}.canvas-container{max-height:500px}}@media (prefers-color-scheme:dark){:root{--background-color:#0f172a;--text-color:#f8fafc;--border-color:#334155}.section{background-color:#1e293b}table th{background-color:#334155}.cal-result{background-color:#334155}.file-name{color:#94a3b8}}
  
    .file-input-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center; /* æ°´å¹³ç½®ä¸­ */
    width: 100%;
    gap: 10px;
  }
  .file-input-wrapper > div {
    display: flex;
    justify-content: center; /* æ°´å¹³ç½®ä¸­ */
    width: 100%;
  }
  .file-input-wrapper .file-label {
    display: inline-flex;
    max-width: 250px; /* å¯é¸ï¼šé™åˆ¶æœ€å¤§å¯¬åº¦ */
    justify-content: center; /* æŒ‰éˆ•å…§å®¹ç½®ä¸­ */
  }
  </style>
  <!-- PWA åŸºæœ¬å…ƒæ¨™ç±¤ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <!-- å¼•ç”¨ manifest.json -->
  <link rel="manifest" href="./manifest.json">

  <!-- å¼•ç”¨ Service Worker è¨»å†Šè…³æœ¬ -->
  <script src="./sw-register.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š å…‰è­œåˆ†æï¼ˆå·²çŸ¥æ ¡æ­£åƒæ•¸ï¼‰</h1>
    </div>
    
    <div class="section">
      <h2 class="section-title">åƒæ•¸è¨­å®š</h2>
      
      <div class="file-input-wrapper">
        <div class="file-buttons">
          <label for="csvInput" class="file-label">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right:8px">
              <path d="M3 15C3 17.8284 3 19.2426 3.87868 20.1213C4.75736 21 6.17157 21 9 21H15C17.8284 21 19.2426 21 20.1213 20.1213C21 19.2426 21 17.8284 21 15M12 3L12 15M12 15L16 11M12 15L8 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            åŒ¯å…¥åƒæ•¸æª” (CSV)
          </label>
          <input type="file" id="csvInput" accept=".csv" />
        </div>
        <div id="csvFileName" class="file-name"></div>
      </div>
      
      <div id="parametersDisplay" style="display:none">
        <div class="cal-result" id="regressionResult">å°šæœªè¼‰å…¥åƒæ•¸</div>
        
        <table class="parameters-table">
          <tr>
            <td>Xèµ·é»ï¼š</td>
            <td id="paramXStart">-</td>
          </tr>
          <tr>
            <td>Xçµ‚é»ï¼š</td>
            <td id="paramXEnd">-</td>
          </tr>
          <tr>
            <td>æ³¢é•·èµ·é»ï¼š</td>
            <td id="paramWavelengthStart">-</td>
          </tr>
          <tr>
            <td>æ³¢é•·çµ‚é»ï¼š</td>
            <td id="paramWavelengthEnd">-</td>
          </tr>
          <tr>
            <td>å›æ­¸ç·šæ–œç‡ï¼š</td>
            <td id="paramSlope">-</td>
          </tr>
          <tr>
            <td>å›æ­¸ç·šæˆªè·ï¼š</td>
            <td id="paramIntercept">-</td>
          </tr>
        </table>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title">å…‰è­œåœ–åƒ</h2>
      
      <div id="sampleEmptyState" class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 16L8.586 11.414C8.96106 11.0391 9.46967 10.8284 10 10.8284C10.5303 10.8284 11.0389 11.0391 11.414 11.414L16 16M14 14L15.586 12.414C15.9611 12.0391 16.4697 11.8284 17 11.8284C17.5303 11.8284 18.0389 12.0391 18.414 12.414L20 14M14 8H14.01M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h3>å°šæœªæ·»åŠ åœ–åƒ</h3>
        <p>è«‹ä¸Šå‚³å…‰è­œåœ–åƒä»¥é€²è¡Œåˆ†æ</p>
      </div>
      
      <div class="file-input-wrapper" style="margin-top:20px">
        <div class="file-buttons">
          <label for="imgInput" class="file-label">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right:8px">
              <path d="M4 16L8.586 11.414C8.96106 11.0391 9.46967 10.8284 10 10.8284C10.5303 10.8284 11.0389 11.0391 11.414 11.414L16 16M14 14L15.586 12.414C15.9611 12.0391 16.4697 11.8284 17 11.8284C17.5303 11.8284 18.0389 12.0391 18.414 12.414L20 14M14 8H14.01M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            é¸æ“‡å…‰è­œåœ–åƒ
          </label>
          <input type="file" id="imgInput" accept="image/*" />
        </div>
      </div>
      
      <div id="currentImageContainer" style="margin-top:15px;display:none;width:100%">
        <div id="currentImageName" style="margin-bottom:10px;font-weight:500"></div>
        <div style="width:100%;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);border-radius:var(--border-radius);overflow:hidden;margin-bottom:20px">
          <img id="currentImage" style="width:100%;height:auto;display:block;border-radius:var(--border-radius)" />
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title">æ³¢é•·å¼·åº¦åˆ†æ</h2>
      
      <div id="plotEmptyState" class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 21H3V3M20 7L14 13L10 9L4 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h3>å°šæœªç”¢ç”Ÿåœ–è¡¨</h3>
        <p>è¼‰å…¥åƒæ•¸èˆ‡åœ–åƒå¾Œï¼Œé»æ“Šåˆ†ææŒ‰éˆ•ç”¢ç”Ÿåœ–è¡¨</p>
      </div>
      
      <div id="wavelengthPlotContainer" style="display:none">
        <div id="wavelengthPlot" class="plot-container"></div>
      </div>
      
      <div class="button-row" style="margin-top:20px">
        <button id="analyzeBtn" class="btn-primary" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 21H3V3M20 7L14 13L10 9L4 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ç”¢ç”Ÿæ³¢é•·å¼·åº¦åˆ†æåœ–
        </button>
        <button id="toggleBackgroundBtn" class="btn-outline" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 16L8.586 11.414C8.96106 11.0391 9.46967 10.8284 10 10.8284C10.5303 10.8284 11.0389 11.0391 11.414 11.414L16 16M14 14L15.586 12.414C15.9611 12.0391 16.4697 11.8284 17 11.8284C17.5303 11.8284 18.0389 12.0391 18.414 12.414L20 14M14 8H14.01M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          åŠ å…¥èƒŒæ™¯åœ–
        </button>
      </div>
    </div>
  </div>

  <script>
    // ä½¿ç”¨ç°¡çŸ­è®Šæ•¸åç²å–DOMå…ƒç´ 
    const $ = id => document.getElementById(id),
          csvInput = $('csvInput'),
          imgInput = $('imgInput'),
          params = {display: $('parametersDisplay'), result: $('regressionResult')},
          ui = {
            csvFileName: $('csvFileName'),
            paramXStart: $('paramXStart'),
            paramXEnd: $('paramXEnd'),
            paramWLStart: $('paramWavelengthStart'),
            paramWLEnd: $('paramWavelengthEnd'),
            paramSlope: $('paramSlope'),
            paramIntercept: $('paramIntercept'),
            sampleEmpty: $('sampleEmptyState'),
            plotEmpty: $('plotEmptyState'),
            imgContainer: $('currentImageContainer'),
            imgName: $('currentImageName'),
            img: $('currentImage'),
            plotContainer: $('wavelengthPlotContainer'),
            plot: $('wavelengthPlot'),
            analyzeBtn: $('analyzeBtn'),
            bgBtn: $('toggleBackgroundBtn')
          };
    
    // å…¨å±€è®Šé‡
    let parameters = null,
        currentSample = null,
        bgImageOn = false;
    
    // åˆå§‹åŒ–æ‡‰ç”¨
    function init() {
      // è¨­ç½®äº‹ä»¶ç›£è½å™¨
      csvInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) loadCSV(file);
      });
      
      imgInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) loadImage(file);
        e.target.value = '';
      });
      
      ui.analyzeBtn.addEventListener('click', analyze);
      ui.bgBtn.addEventListener('click', toggleBackground);
      
      // çª—å£å¤§å°æ”¹è®Šæ™‚èª¿æ•´åœ–è¡¨
      window.addEventListener('resize', () => {
        const plotEl = $('wavelengthPlot');
        if (plotEl.data && plotEl.data.length > 0) {
          Plotly.relayout(plotEl, {width: plotEl.clientWidth});
        }
      });
      
      // ç‰ˆæœ¬ä¿¡æ¯
      const versionDiv = document.createElement('div');
      versionDiv.style.cssText = 'text-align:center;margin-top:20px;font-size:12px;color:#666';
      versionDiv.textContent = 'å…‰è­œåˆ†æï¼ˆå·²çŸ¥æ ¡æ­£åƒæ•¸ï¼‰ v1.1 - æ•ˆèƒ½å„ªåŒ–ç‰ˆ';
      document.querySelector('.container').appendChild(versionDiv);
      
      // é›¢ç·šæ”¯æ´
      if (!navigator.onLine) notify('ç•¶å‰è™•æ–¼é›¢ç·šæ¨¡å¼', 'info');
      window.addEventListener('online', () => notify('å·²æ¢å¾©ç¶²çµ¡é€£æ¥', 'success'));
      window.addEventListener('offline', () => notify('å·²é€²å…¥é›¢ç·šæ¨¡å¼', 'info'));
    }
    
    // è¼‰å…¥CSVåƒæ•¸æª”
    function loadCSV(file) {
      ui.csvFileName.textContent = file.name;
      
      const reader = new FileReader();
      reader.onload = e => {
        try {
          parseCSV(e.target.result);
          updateUI();
          notify('åƒæ•¸æª”æ¡ˆå·²æˆåŠŸè¼‰å…¥', 'success');
        } catch (err) {
          console.error('CSVè§£æéŒ¯èª¤:', err);
          notify('ç„¡æ³•è§£æåƒæ•¸æª”æ¡ˆï¼Œè«‹ç¢ºä¿æ ¼å¼æ­£ç¢º', 'error');
        }
      };
      
      reader.onerror = () => notify('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
      reader.readAsText(file);
    }
    
    // è§£æCSVå…§å®¹
    function parseCSV(csv) {
      const lines = csv.split('\n');
      const p = {}, calibPoints = [];
      let inCalibSection = false;
      
      lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('calibration_index')) {
          inCalibSection = true;
          return;
        }
        
        const parts = line.split(',');
        
        if (inCalibSection) {
          if (parts.length >= 3) {
            calibPoints.push({
              index: parseInt(parts[0]),
              pixel: parseInt(parts[1]),
              wavelength: parseFloat(parts[2])
            });
          }
        } else if (parts.length >= 2 && !parts[0].includes('åƒæ•¸åç¨±')) {
          p[parts[0]] = parseFloat(parts[1]);
        }
      });
      
      parameters = {
        xStart: p.xStart || 0,
        xEnd: p.xEnd || 0,
        wavelengthStart: p.wavelengthStart || 0,
        wavelengthEnd: p.wavelengthEnd || 0,
        regressionSlope: p.regressionSlope || 0,
        regressionIntercept: p.regressionIntercept || 0,
        calibrationPoints: calibPoints
      };
      
      // æ›´æ–°åƒæ•¸é¡¯ç¤º
      ui.paramXStart.textContent = parameters.xStart;
      ui.paramXEnd.textContent = parameters.xEnd;
      ui.paramWLStart.textContent = parameters.wavelengthStart.toFixed(2) + ' nm';
      ui.paramWLEnd.textContent = parameters.wavelengthEnd.toFixed(2) + ' nm';
      ui.paramSlope.textContent = parameters.regressionSlope.toFixed(6);
      ui.paramIntercept.textContent = parameters.regressionIntercept.toFixed(2);
      
      params.result.textContent = `Î» = ${parameters.regressionSlope.toFixed(4)} Ã— x + ${parameters.regressionIntercept.toFixed(2)}`;
    }
    
    // è¼‰å…¥åœ–åƒ
    function loadImage(file) {
      // æ¸…é™¤å…ˆå‰æ•¸æ“š
      resetChart();
      
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          // å‰µå»ºæ¨£æœ¬å°è±¡
          currentSample = {
            name: file.name,
            width: img.naturalWidth,
            height: img.naturalHeight,
            image: img,
            imageUrl: e.target.result
          };
          
          // é¡¯ç¤ºåœ–åƒ
          ui.imgContainer.style.display = 'block';
          ui.imgName.textContent = file.name;
          ui.img.src = e.target.result;
          
          // å¼·åˆ¶ç€è¦½å™¨é‡æ–°è¨ˆç®—åœ–åƒå°ºå¯¸
          setTimeout(() => {
            ui.img.style.width = 'calc(100% - 2px)';
            setTimeout(() => ui.img.style.width = '100%', 10);
          }, 50);
          
          // éš±è—ç©ºç‹€æ…‹
          ui.sampleEmpty.style.display = 'none';
          updateUI();
          notify('åœ–åƒå·²è¼‰å…¥: ' + file.name, 'success');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    // é‡è¨­åœ–è¡¨
    function resetChart() {
      currentSample = null;
      ui.plotContainer.style.display = 'none';
      ui.plotEmpty.style.display = 'block';
      ui.bgBtn.disabled = true;
      bgImageOn = false;
      
      // æ¸…é™¤åœ–è¡¨
      const plotEl = $('wavelengthPlot');
      if (plotEl.data && plotEl.data.length > 0) {
        Plotly.purge(plotEl);
      }
    }
    
    // æ›´æ–°UIç‹€æ…‹
    function updateUI() {
      // æ›´æ–°åƒæ•¸é¡¯ç¤º
      params.display.style.display = parameters ? 'block' : 'none';
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      ui.analyzeBtn.disabled = !(parameters && currentSample);
    }
    
    // åˆ†æåœ–åƒ
    function analyze() {
      if (!parameters || !currentSample) {
        notify('è«‹å…ˆè¼‰å…¥åƒæ•¸æª”æ¡ˆèˆ‡åœ–åƒ', 'error');
        return;
      }
      
      processSample().then(success => {
        if (success) {
          generatePlot();
          notify('åˆ†æå®Œæˆ', 'success');
        } else {
          notify('åˆ†æå¤±æ•—', 'error');
        }
      });
    }
    
    // è™•ç†æ¨£æœ¬
    function processSample() {
      return new Promise(resolve => {
        // å‰µå»ºé›¢å±ç•«å¸ƒ
        const canvas = document.createElement('canvas');
        canvas.width = currentSample.width;
        canvas.height = currentSample.height;
        const ctx = canvas.getContext('2d');
        
        try {
          // ç¹ªè£½åœ–åƒåˆ°ç•«å¸ƒ
          ctx.drawImage(currentSample.image, 0, 0);
          
          // ç²å–åœ–åƒæ•¸æ“š
          const imageData = ctx.getImageData(0, 0, currentSample.width, currentSample.height);
          const pixelData = imageData.data;
          
          // å®šç¾©æ„Ÿèˆˆè¶£å€åŸŸ
          const x1 = parameters.xStart;
          const x2 = parameters.xEnd;
          const y1 = Math.floor(currentSample.height * 0.45);
          const y2 = Math.floor(currentSample.height * 0.55);
          
          // è¨ˆç®—å¼·åº¦èˆ‡æ³¢é•·
          const wavelengths = [], intensities = [];
          
          for (let x = x1; x <= x2; x++) {
            let sum = 0, count = 0;
            
            for (let y = y1; y <= y2; y++) {
              const idx = (y * currentSample.width + x) * 4;
              if (idx < pixelData.length) {
                // è¨ˆç®—å¼·åº¦ï¼ˆRGBå¹³å‡å€¼ï¼‰
                sum += (pixelData[idx] + pixelData[idx + 1] + pixelData[idx + 2]) / 3;
                count++;
              }
            }
            
            // è¨ˆç®—å¹³å‡å¼·åº¦
            const avgIntensity = count > 0 ? sum / count : 0;
            
            // è¨ˆç®—æ³¢é•·
            const wavelength = parameters.regressionSlope * x + parameters.regressionIntercept;
            
            wavelengths.push(wavelength);
            intensities.push(avgIntensity);
          }
          
          // ä¿å­˜æ•¸æ“š
          currentSample.data = {
            wavelengths,
            intensities,
            roi: {x1, x2, y1, y2}
          };
          
          // ä¿å­˜èƒŒæ™¯åœ–
          try {
            currentSample.bgImage = getCropDataURL(canvas, x1, x2, y1, y2);
          } catch (e) {
            console.warn('ç„¡æ³•ç”ŸæˆèƒŒæ™¯åœ–', e);
          }
          
          resolve(true);
        } catch (err) {
          console.error('è™•ç†æ¨£æœ¬æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
          resolve(false);
        }
      });
    }
    
    // ç²å–è£å‰ªåœ–åƒURL
    function getCropDataURL(canvas, x1, x2, y1, y2) {
      const cropCanvas = document.createElement('canvas');
      const cropWidth = x2 - x1 + 1;
      const cropHeight = y2 - y1 + 1;
      
      cropCanvas.width = cropWidth;
      cropCanvas.height = cropHeight;
      
      const ctx = cropCanvas.getContext('2d');
      ctx.drawImage(
        canvas, 
        x1, y1, cropWidth, cropHeight,
        0, 0, cropWidth, cropHeight
      );
      
      return cropCanvas.toDataURL();
    }
    
    // ç”Ÿæˆæ³¢é•·å¼·åº¦åœ–
    function generatePlot() {
      if (!currentSample?.data) return;
      
      // é¡¯ç¤ºåœ–è¡¨ï¼Œéš±è—ç©ºç‹€æ…‹
      ui.plotContainer.style.display = 'block';
      ui.plotEmpty.style.display = 'none';
      
      // å‰µå»ºåœ–è¡¨
      Plotly.newPlot('wavelengthPlot', [{
        x: currentSample.data.wavelengths,
        y: currentSample.data.intensities,
        mode: 'lines',
        name: currentSample.name,
        line: {color: '#3b82f6', width: 3}
      }], {
        margin: {t: 20, r: 20, b: 40, l: 50},
        xaxis: {
          title: 'æ³¢é•· (nm)',
          showline: true,
          mirror: true,
          ticks: 'outside',
          linecolor: 'black',
          linewidth: 2,
          tickfont: {size: 14}
        },
        yaxis: {
          title: 'å¼·åº¦',
          showline: true,
          mirror: true,
          ticks: 'outside',
          linecolor: 'black',
          linewidth: 2,
          tickfont: {size: 14}
        },
        dragmode: 'pan',
        modeBarButtonsToAdd: [
          'hoverClosestCartesian',
          'hoverCompareCartesian',
          'toggleSpikelines'
        ],
        hovermode: 'closest',
        images: [],
        plot_bgcolor: 'rgba(255,255,255,0)',
        paper_bgcolor: 'rgba(255,255,255,0)'
      }, {
        displayModeBar: true,
        responsive: true,
        toImageButtonOptions: {
          format: 'png',
          filename: 'spectrum_wavelength_analysis',
          scale: 2
        },
        modeBarButtonsToRemove: ['lasso2d', 'select2d', 'autoScale2d']
      });
      
      // å•Ÿç”¨èƒŒæ™¯æŒ‰éˆ•
      ui.bgBtn.disabled = false;
      // åœ¨å‰µå»ºåœ–è¡¨å¾Œè¨­ç½®è‡ªå®šç¾©ä¸‹è¼‰æŒ‰éˆ•
      setTimeout(() => setupCustomDownloadButton('wavelengthPlot', 'spectrum_wavelength_analysis.png'), 500);
      bgImageOn = false;
      updateBgButton(false);
    }
    
    // åˆ‡æ›èƒŒæ™¯åœ–
    function toggleBackground() {
      if (!currentSample?.data) return;
      
      if (!bgImageOn) {
        // æ·»åŠ èƒŒæ™¯åœ–
        if (currentSample.bgImage) {
          Plotly.relayout('wavelengthPlot', {
            images: [{
              source: currentSample.bgImage,
              xref: 'x',
              yref: 'paper',
              x: parameters.wavelengthStart,
              y: 1,
              sizex: parameters.wavelengthEnd - parameters.wavelengthStart,
              sizey: 1,
              sizing: 'stretch',
              opacity: 0.5,
              layer: 'below'
            }]
          });
          
          bgImageOn = true;
          updateBgButton(true);
        } else {
          notify('æ²’æœ‰å¯ç”¨çš„èƒŒæ™¯åœ–', 'error');
        }
      } else {
        // ç§»é™¤èƒŒæ™¯åœ–
        Plotly.relayout('wavelengthPlot', {images: []});
        bgImageOn = false;
        updateBgButton(false);
      }
      // åœ¨èƒŒæ™¯åˆ‡æ›å¾Œæ›´æ–°ä¸‹è¼‰æŒ‰éˆ•
      setTimeout(() => setupCustomDownloadButton('wavelengthPlot', 'spectrum_wavelength_analysis.png'), 500);
    }
    
    // æ›´æ–°èƒŒæ™¯æŒ‰éˆ•æ¨£å¼å’Œæ–‡å­—
    function updateBgButton(isActive) {
      if (isActive) {
        ui.bgBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 5L5 19M12 12L19 5M12 12L5 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ç§»é™¤èƒŒæ™¯åœ–
        `;
        ui.bgBtn.classList.remove('btn-outline');
        ui.bgBtn.classList.add('btn-danger');
      } else {
        ui.bgBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 16L8.586 11.414C8.96106 11.0391 9.46967 10.8284 10 10.8284C10.5303 10.8284 11.0389 11.0391 11.414 11.414L16 16M14 14L15.586 12.414C15.9611 12.0391 16.4697 11.8284 17 11.8284C17.5303 11.8284 18.0389 12.0391 18.414 12.414L20 14M14 8H14.01M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          åŠ å…¥èƒŒæ™¯åœ–
        `;
        ui.bgBtn.classList.add('btn-outline');
        ui.bgBtn.classList.remove('btn-danger');
      }
    }
    
    // é¡¯ç¤ºé€šçŸ¥
    function notify(message, type = 'info') {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position:fixed;
        bottom:20px;
        left:50%;
        transform:translateX(-50%);
        padding:12px 20px;
        border-radius:8px;
        font-weight:500;
        box-shadow:0 4px 12px rgba(0,0,0,.15);
        z-index:9999;
        max-width:80%;
        text-align:center;
        background-color:${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color:white;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s ease';
        setTimeout(() => document.body.removeChild(notification), 500);
      }, 2000);
    }
    
    // è¨­ç½®è‡ªå®šç¾©ä¸‹è¼‰æŒ‰éˆ•
    function setupCustomDownloadButton(plotId, filename = 'spectrum.png') {
      const modebar = document.querySelector(`#${plotId} .modebar`);
      if (!modebar) return;

      const downloadBtn = modebar.querySelector(".modebar-btn[data-title='Download plot as a png']");
      if (!downloadBtn) return;

      // å…ˆç§»é™¤åŸæœ¬ onclick
      downloadBtn.onclick = null;

      // æ”¹æˆæ‰‹å‹•è™•ç†ä¸‹è¼‰
      downloadBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          const dataUrl = await Plotly.toImage(plotId, {
            format: "png",
            height: 600,
            width: 800,
            scale: 2
          });

          const link = document.createElement("a");
          link.href = dataUrl;
          link.download = filename; // æŒ‡å®šæ˜ç¢ºçš„å‰¯æª”å
          link.target = "_blank";
          link.rel = "noopener";

          // iOS ç‰¹åˆ¥è™•ç†ï¼šä½¿ç”¨ data URL é–‹å•Ÿæ–°é ç±¤æ¯”è¼ƒç©©
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
          if (isIOS) {
            const win = window.open();
            win.document.write(`<html><body style="margin:0;"><img src="${dataUrl}" style="width:100%;"/></body></html>`);
          } else {
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }

        } catch (err) {
          console.error("ä¸‹è¼‰åœ–åƒå¤±æ•—ï¼š", err);
          notify("åœ–åƒä¸‹è¼‰å¤±æ•—", "error");
        }
      });
    }
    // å•Ÿå‹•æ‡‰ç”¨
    init();
  </script>
</body>
</html>
